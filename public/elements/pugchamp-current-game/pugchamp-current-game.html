<link rel="import" href="/components/polymer/polymer.html">

<link rel="import" href="/components/paper-button/paper-button.html">
<link rel="import" href="/components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/components/paper-item/paper-item.html">
<link rel="import" href="/components/paper-material/paper-material.html">
<link rel="import" href="/components/paper-menu/paper-menu.html">
<link rel="import" href="/components/paper-styles/color.html">

<script src="/components/lodash/lodash.min.js"></script>

<link rel="import" href="/elements/pugchamp-client/pugchamp-client-base-behavior.html">
<link rel="import" href="/elements/pugchamp-client/pugchamp-client-user-behavior.html">
<link rel="import" href="/elements/pugchamp-utilities/pugchamp-polymer-helpers.html">

<dom-module id="pugchamp-current-game">
	<template>
		<style is="custom-style">
            #game {
                padding: 5px 25px;
                margin: 20px;
            }

			a.button {
				color: inherit;
			}

            #connect {
                background: var(--primary-color);
                color: var(--dark-theme-text-color);
            }
		</style>

        <paper-material id="game" hidden$="{{!game}}">
            <h2>Current Game</h2>

			<p><a class="button" href="/game/{{game.id}}" target="_blank"><paper-button raised>View Game Info</paper-button></a></p>

			<div hidden$="{{!player}}">
				<h3>Player</h3>

				<p>
					<strong>Role</strong>: {{_getProperty(game.roles, player.role, 'name')}}
					<br>
					<strong>Faction</strong>: {{team.faction}}
					<br>
					<strong>Captain</strong>: {{team.captain.alias}}
				</p>

	            <p><a class="button" href="steam://connect/{{game.server.address}}/{{game.server.password}}"><paper-button id="connect" raised>Connect to Server</paper-button></a></p>
			</div>

			<div hidden$="{{!captain}}">
				<h3>Captain</h3>

				<p>
					<paper-dropdown-menu id="replacedPlayer" label="Player to Replace">
						<paper-menu class="dropdown-content">
							<template is="dom-repeat" items="{{team.composition}}" as="role">
								<template is="dom-repeat" items="{{role.players}}">
									<template is="dom-if" if="{{item.replaced">
										<paper-item value="{{item.user.steamID}}">{{item.user.alias}} ({{_getProperty(game.roles, role.role, 'name')}})</paper-item>
									</template>
								</template>
							</template>
						</paper-menu>
					</paper-dropdown-menu>
					<paper-button on-tap="requestSubstitute" raised>Request Substitute</paper-button></a>
				</p>
			</div>
        </paper-material>
	</template>
	<script>
	    Polymer({
			is: 'pugchamp-current-game',
			behaviors: [PugChampClientBehaviors.BaseBehavior, PugChampClientBehaviors.UserBehavior, PugChampPolymerHelperBehaviors],
	        ready: function() {
                this.set('game', null);
				this.set('player', null);
				this.set('captain', null);

				this._listenToEvent('currentGameUpdated', 'onCurrentGameUpdated');
	        },
            onCurrentGameUpdated: function(info) {
                this.set('game', info);

				if (info) {
					this.set('team', _.find(info.teams, function(team) {
						this.set('captain', team.captain.steamID == this.user.steamID);

						this.set('player', _.find(team.composition, function(role) {
							return _.some(role.players, {
								user: {
									steamID: this.user.steamID
								}
							}, this);
						}, this));

						return this.captain || this.player;
					}, this));
				}
            },
			requestSubstitute: function(event) {
				this.socket.emit('requestSubstitute', {
                    game: this.game.id,
                    player: this.$.replacedPlayer.selectedItem.value
                });
			}
	    });
	</script>
</dom-module>
