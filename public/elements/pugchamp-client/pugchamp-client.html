<link rel="import" href="/components/polymer/polymer.html">

<link rel="import" href="/components/iron-ajax/iron-ajax.html">
<link rel="import" href="/components/paper-material/paper-material.html">
<link rel="import" href="/components/paper-styles/color.html">
<link rel="import" href="/components/paper-toast/paper-toast.html">

<link rel="import" href="/elements/pugchamp-client/pugchamp-client-base-behavior.html">
<link rel="import" href="/elements/pugchamp-notification/pugchamp-notification.html">
<link rel="import" href="/elements/pugchamp-sound/pugchamp-sound.html">

<dom-module id="pugchamp-client">
    <template>
        <style is="custom-style">
            #client {
                position: relative;
            }

            #client.disconnected {
                opacity: 0.5;
            }

            #disconnectedOverlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 10;
                background-color: rgba(0, 0, 0, 0.5);
            }

            #disconnectedOverlay.connected {
                display: none;
            }

            #disconnectedMessage {
                --paper-dialog-background-color: var(--paper-red-500);
                --paper-dialog-color: var(--light-theme-text-color);
            }
        </style>

        <div id="client" class$="{{connectionStatus(connected)}}">
            <content></content>
            <div id="disconnectedOverlay" class$="{{connectionStatus(connected)}}"></div>
        </div>
        <paper-dialog id="disconnectedMessage" no-cancel-on-esc-key no-cancel-on-outside-click>
            <p>You are currently disconnected from the server.</p>

            <div class="buttons">
                <paper-button on-tap="reconnect" dialog-confirm>Reconnect</paper-button>
            </div>
        </paper-dialog>

        <iron-ajax id="token" url="/user/token" on-response="infoReceived"></iron-ajax>

        <pugchamp-notification id="disconnectNotification" body="You have lost connection to the server." tag="disconnect"></pugchamp-notification>
        <pugchamp-sound id="disconnectSound" src="/assets/snd/client/disconnected.wav"></pugchamp-sound>
        <paper-toast text="Connected to the server." id="connectAlert"></paper-toast>
        <paper-toast text="Disconnected from the server." id="disconnectAlert"></paper-toast>
        <paper-toast text="Failed to reconnect to the server." id="reconnectFailedAlert"></paper-toast>
        <paper-toast text="Logged in with the server." id="authenticatedAlert"></paper-toast>
        <paper-toast text="Failed to log in with the server." id="authenticationFailedAlert"></paper-toast>
    </template>

    <script>
        Polymer({
            is: 'pugchamp-client',
            behaviors: [PugChampClientBehaviors.BaseBehavior],
            ready: function() {
                this._listenToEvent('connect', 'onConnect');
                this._listenToEvent('reconnect', 'onReconnect');
                this._listenToEvent('disconnect', 'onDisconnect');
                this._listenToEvent('reconnect_failed', 'onReconnectFailed');
                this._listenToEvent('unauthorized', 'onUnauthorized');
                this._listenToEvent('authenticated', 'onAuthenticated');

                this.socket.connect();

                this.authenticated = false;
                this.$.token.generateRequest();

                this.async(function() {
                    this.$.disconnectedMessage.fitInto = this.$.client;
                    this.$.disconnectedMessage.refit();
                });
            },
            onConnect: function() {
                this.$.connectAlert.show();

                this.authenticate();

                this.toggleDisconnectDisplay();
            },
            onReconnect: function() {
                this.$.connectAlert.show();

                this.authenticate();

                this.toggleDisconnectDisplay();
            },
            onDisconnect: function() {
                this.authenticated = false;

                this.$.disconnectAlert.show();
                this.$.disconnectNotification.notify();
                this.$.disconnectSound.play();

                this.toggleDisconnectDisplay();
            },
            onReconnectFailed: function() {
                this.$.reconnectFailedAlert.show();

                this.toggleDisconnectDisplay();
            },
            onUnauthorized: function(error) {
                this.authenticated = false;

                this.$.authenticationFailedAlert.show();

                if (error.data && error.data.type === 'UnauthorizedError' && error.data.code === 'invalid_token') {
                    this.$.token.generateRequest();
                }
            },
            onAuthenticated: function() {
                this.authenticated = true;

                this.$.authenticatedAlert.show();
            },
            infoReceived: function(event) {
                this.token = event.detail.response.token;

                this.authenticate();
            },
            authenticate: function() {
                if (this.socket.connected && this.token) {
                    this.socket.emit('authenticate', {
                        token: this.token
                    });

                    this.async(this.retryAuthentication, 1000);
                }
            },
            toggleDisconnectDisplay: function() {
                this.set('connected', this.socket.connected);

                if (this.socket.connected) {
                    this.$.disconnectedMessage.close();
                }
                else {
                    this.$.disconnectedMessage.open();
                }
            },
            reconnect: function() {
                this.socket.io.reconnect();
            },
            retryAuthentication: function() {
                if (!this.authenticated) {
                    this.$.token.generateRequest();
                }
            },
            connectionStatus: function(connected) {
                return connected ? 'connected' : 'disconnected';
            }
        });
    </script>
</dom-module>
