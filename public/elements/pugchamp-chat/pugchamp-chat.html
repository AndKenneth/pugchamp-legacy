<link rel="import" href="/components/polymer/polymer.html">

<link rel="import" href="/components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="/components/iron-icons/iron-icons.html">
<link rel="import" href="/components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/components/paper-input/paper-textarea.html">
<link rel="import" href="/components/paper-material/paper-material.html">
<link rel="import" href="/components/paper-styles/typography.html">
<link rel="import" href="/components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="/components/iron-list/iron-list.html">

<link rel="import" href="/elements/pugchamp-client/pugchamp-client-base-behavior.html">
<link rel="import" href="/elements/pugchamp-client/pugchamp-client-restrictions-behavior.html">
<link rel="import" href="/elements/pugchamp-theme/theme.html">

<dom-module id="pugchamp-chat">
    <template>
        <style is="custom-style">
            #messages {
                height: calc(65vh - 175px);
                overflow-y: auto;
            }

            .message {
                background: var(--box-background-color);
                margin: 5px;
                padding: 5px;
            }

            .message .message-time {
                @apply(--paper-font-common-base);
                @apply(--paper-font-common-nowrap);
                font-size: 12px;
                font-weight: 400;
                letter-spacing: 0.011em;
                line-height: 24px;
                margin-right: 5px;
            }

            .message .message-contents {
                overflow: hidden;
            }

            .message .message-author {
                @apply(--paper-font-body2);
            }

            .message .message-action {
                line-height: 24px;
            }

            .message .message-body {
                @apply(--paper-font-common-base);
                overflow-wrap: break-word;
                word-wrap: break-word;
            }
			#online {
                height: calc(50vh - 175px);
			}
			.avatar {
				height: 40px;
				width: 40px;
				border-radius: 20px;
				box-sizing: border-box;
				line-height:40px;
			}
			.player-alias {
			line-height: 40px;
			margin-left: 10px;
			}
			.player-online {
				background-color: var(--tf2-theme-brown-color-faded);
				padding:3px;
				margin-bottom: 3px;
			}
			.player-online a, .player-online a:visited {
			color: var(--tf2-theme-cream-color);
			text-decoration:none;
			}
        </style>

        <div id="messages">
            <template is="dom-repeat" items="{{messages}}">
                <paper-material class="message horizontal layout">
                    <div class="message-time">{{formatTime(item.time)}}</div>
                    <div class="flex message-contents">
                        <template is="dom-if" if="{{item.user}}">
                            <span class="message-author"><iron-icon hidden$="{{!item.user.admin}}" icon="flag"></iron-icon> {{item.user.alias}}</span>
                        </template>
                        <em class="message-action">{{item.action}}</em>
                        <br>
                        <span class="message-body">{{item.body}}</span>
                    </div>
                </paper-material>
            </template>
        </div>
        <div class="horizontal layout end wrap">

            <iron-a11y-keys id="submitWatcher" keys="enter" on-keys-pressed="onEnter"></iron-a11y-keys>
            <paper-textarea id="messageText" class="flex" maxlength="140" max-rows="3" char-counter disabled="{{isRestricted(restrictions, 'chat')}}"></paper-textarea>
            <paper-icon-button icon="send" on-tap="sendMessage" disabled="{{isRestricted(restrictions, 'chat')}}"></paper-icon-button>
        </div>
		<div id="online" >
		<h3> Online Users </h3>
			<template is="dom-repeat" items="{{onlineList}}">
					<div class="player-online horizontal layout wrap">
						<img class="avatar" src="/assets/img/profile/temp-avatar.jpg">
						<div class="player-alias flex"><a href="/player/{{item.steamID}}" target="_blank">{{item.alias}}</a> </div>
						<div class="player-twitch "><a href="https://www.twitch.tv/{{item.twitchID}}"> Twitch</a></div>
					</div>
			</template>
	
		</div>
    </template>

    <script src="/components/moment/moment.js"></script>
    <script>
        Polymer({
            is: 'pugchamp-chat',
            behaviors: [PugChampClientBehaviors.BaseBehavior, PugChampClientBehaviors.RestrictionsBehavior],
            ready: function() {
                this.set('messages', []);
                this.set('onlineList', []);

                this.$.submitWatcher.target = this.$.messageText;

                this._listenToEvent('messageReceived', 'onMessageReceived');
                this._listenToEvent('onlineUserListUpdated', 'onOnlineUserListUpdated');
            },
            onOnlineUserListUpdated: function(list) {
                this.set('onlineList', list);
				
            },
            onMessageReceived: function(message) {
                var atBottom = this.$.messages.scrollHeight - this.$.messages.scrollTop === this.$.messages.clientHeight;

                message.time = new Date();

                this.push('messages', message);

                if (atBottom) {
                    this.async(function() {
                        this.$.messages.scrollTop = this.$.messages.scrollHeight - this.$.messages.clientHeight;
                    }, 10);
                }
            },
            onEnter: function(event) {
                event.detail.keyboardEvent.preventDefault();

                this.sendMessage();
            },
            sendMessage: function() {
                socket.emit('sendChatMessage', this.$.messageText.value);
                this.$.messageText.value = '';
            },
            formatTime: function(time) {
                return moment(time).format('LT');
            }
        });
    </script>
</dom-module>
