<link rel="import" href="/components/polymer/polymer.html">

<link rel="import" href="/components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="/components/iron-icons/iron-icons.html">
<link rel="import" href="/components/paper-card/paper-card.html">
<link rel="import" href="/components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/components/paper-input/paper-textarea.html">

<link rel="import" href="/elements/pugchamp-client/pugchamp-client-base-behavior.html">
<link rel="import" href="/elements/pugchamp-client/pugchamp-client-restrictions-behavior.html">

<dom-module id="pugchamp-chat">
	<template>
		<style is="custom-style">
			#chatMessages {
				height: 500px;
				padding: 5px;
				overflow: auto;
			}
			#msg-body {
			overflow-wrap:break-word;
			word-wrap:break-word;
			}
			.chat-message {
				width: 100%;
				margin: 5px 0;
			}
		</style>

		<div id="chatMessages">
			<template is="dom-repeat" items="{{messages}}">
				<paper-card class="chat-message">
					<div class="card-content"><div id="msg-body"> {{item}} </div></div>
					
				</paper-card>
			</template>
		</div>
		<div class="horizontal layout end wrap">
			<paper-icon-button icon="favorite" title="heart"></paper-icon-button>
			<iron-a11y-keys id="submitWatcher" keys="enter" on-keys-pressed="onEnter"></iron-a11y-keys>
			<paper-textarea id="messageText" class="flex" maxlength="140" max-rows="3" char-counter disabled="{{isRestricted(restrictions, 'comms')}}"></paper-textarea>
			<paper-icon-button icon="send" on-tap="sendMessage" disabled="{{isRestricted(restrictions, 'comms')}}"></paper-icon-button>
		</div>
	</template>
	<script>
	    Polymer({
			is: 'pugchamp-chat',
			behaviors: [PugChampClientBehaviors.BaseBehavior, PugChampClientBehaviors.RestrictionsBehavior],
	        ready: function() {
				this.set('messages', []);

				this.$.submitWatcher.target = this.$.messageText;
				this._listenToEvent('playerConnectReceived', 'onPlayerConnectReceived');
				this._listenToEvent('chatMessageReceived', 'onChatMessageReceived');
				this._listenToEvent('authenticated', 'onChatConnect');
				this._listenToEvent('disconnect', 'onChatDisconnect');
				
	        },
			onChatMessageReceived: function(chat) {
				var atBottom = this.$.chatMessages.scrollHeight - this.$.chatMessages.scrollTop === this.$.chatMessages.clientHeight;
				var chat = chat.user.alias + ": " + chat.message;
				this.push('messages', chat);
				if (atBottom) {
					this.async(function() {
						this.$.chatMessages.scrollTop = this.$.chatMessages.scrollHeight - this.$.chatMessages.clientHeight;
					});
				}
			},
			onPlayerConnectReceived: function(chat) {
				var atBottom = this.$.chatMessages.scrollHeight - this.$.chatMessages.scrollTop === this.$.chatMessages.clientHeight;
				var chat = chat.user.alias + " " + chat.message;
				this.push('messages', chat);
				if (atBottom) {
					this.async(function() {
						this.$.chatMessages.scrollTop = this.$.chatMessages.scrollHeight - this.$.chatMessages.clientHeight;
					});
				}			
			
			},
			onEnter: function(event) {
				event.detail.keyboardEvent.preventDefault();

				this.sendMessage();
			},
			sendMessage: function() {
				socket.emit('sendChatMessage', this.$.messageText.value);
				this.$.messageText.value = '';
			},
			onChatConnect: function() {
				var message = "connected";
				socket.emit('playerConnected', message);
			},
			//This does not work yet
			onChatDisconnect: function() {
				var message = "disconnected";
				socket.emit('playerConnected', message);
				console.log("here");				
			}
	    });
	</script>
</dom-module>
