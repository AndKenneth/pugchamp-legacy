<link rel="import" href="/components/polymer/polymer.html">

<link rel="import" href="/components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="/components/iron-icons/iron-icons.html">
<link rel="import" href="/components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/components/paper-input/paper-textarea.html">
<link rel="import" href="/components/paper-material/paper-material.html">
<link rel="import" href="/components/paper-styles/typography.html">
<link rel="import" href="/components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="/elements/pugchamp-client/pugchamp-client-base-behavior.html">
<link rel="import" href="/elements/pugchamp-client/pugchamp-client-restrictions-behavior.html">
<link rel="import" href="/elements/pugchamp-theme/theme.html">

<dom-module id="pugchamp-chat">
    <template>
        <style is="custom-style">
            #messages {
                height: calc(100vh - 175px);
                overflow-y: auto;
            }

            .message {
                background: var(--box-background-color);
                margin: 5px;
                padding: 5px;
            }

            .message .message-time {
                @apply(--paper-font-common-base);
                @apply(--paper-font-common-nowrap);
                font-size: 12px;
                font-weight: 400;
                letter-spacing: 0.011em;
                line-height: 24px;
                margin-right: 5px;
            }

            .message .message-contents {
                overflow: hidden;
            }

            .message .message-author {
                @apply(--paper-font-body2);
            }

            .message .message-action {
                line-height: 24px;
            }

            .message .message-body {
                @apply(--paper-font-common-base);
                overflow-wrap: break-word;
                word-wrap: break-word;
            }
        </style>

        <div id="messages">
            <template is="dom-repeat" items="{{messages}}">
                <paper-material class="message horizontal layout">
                    <div class="message-time">{{formatTime(item.time)}}</div>
                    <div class="flex message-contents">
                        <template is="dom-if" if="{{item.user}}">
                            <span class="message-author"><iron-icon hidden$="{{!item.user.admin}}" icon="flag"></iron-icon> {{item.user.alias}}</span>
                        </template>
                        <em class="message-action">{{item.action}}</em>
                        <br>
                        <span class="message-body">{{item.body}}</span>
                    </div>
                </paper-material>
            </template>
        </div>
        <div class="horizontal layout end wrap">
            <paper-icon-button id="online" icon="social:people"></paper-icon-button>
            <paper-tooltip for="online" position="top">
                <strong>Currently online:</strong>
                <template is="dom-repeat" items="{{onlineList}}">
                    <br> {{item.alias}}
                </template>
            </paper-tooltip>
            <iron-a11y-keys id="submitWatcher" keys="enter" on-keys-pressed="onEnter"></iron-a11y-keys>
            <paper-textarea id="messageText" class="flex" maxlength="140" max-rows="3" char-counter disabled="{{isRestricted(restrictions, 'chat')}}"></paper-textarea>
            <paper-icon-button icon="send" on-tap="sendMessage" disabled="{{isRestricted(restrictions, 'chat')}}"></paper-icon-button>
        </div>
    </template>

    <script src="/components/moment/moment.js"></script>
    <script>
        Polymer({
            is: 'pugchamp-chat',
            behaviors: [PugChampClientBehaviors.BaseBehavior, PugChampClientBehaviors.RestrictionsBehavior],
            ready: function() {
                this.set('messages', []);
                this.set('onlineList', []);

                this.$.submitWatcher.target = this.$.messageText;

                this._listenToEvent('messageReceived', 'onMessageReceived');
                this._listenToEvent('onlineUserListUpdated', 'onOnlineUserListUpdated');
            },
            onOnlineUserListUpdated: function(list) {
                this.set('onlineList', list);
            },
            onMessageReceived: function(message) {
                var atBottom = this.$.messages.scrollHeight - this.$.messages.scrollTop === this.$.messages.clientHeight;

                message.time = new Date();

                this.push('messages', message);

                if (atBottom) {
                    this.async(function() {
                        this.$.messages.scrollTop = this.$.messages.scrollHeight - this.$.messages.clientHeight;
                    }, 10);
                }
            },
            onEnter: function(event) {
                event.detail.keyboardEvent.preventDefault();

                this.sendMessage();
            },
            sendMessage: function() {
                socket.emit('sendChatMessage', this.$.messageText.value);
                this.$.messageText.value = '';
            },
            formatTime: function(time) {
                return moment(time).format('LT');
            }
        });
    </script>
</dom-module>