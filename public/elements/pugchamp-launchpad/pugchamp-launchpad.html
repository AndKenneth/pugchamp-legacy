<link rel="import" href="/components/polymer/polymer.html">

<link rel="import" href="/components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="/components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/components/paper-item/paper-item.html">
<link rel="import" href="/components/paper-item/paper-icon-item.html">
<link rel="import" href="/components/paper-material/paper-material.html">
<link rel="import" href="/components/paper-progress/paper-progress.html">
<link rel="import" href="/components/paper-styles/color.html">
<link rel="import" href="/components/paper-styles/default-theme.html">
<link rel="import" href="/components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="/elements/pugchamp-client/pugchamp-client-base-behavior.html">
<link rel="import" href="/elements/pugchamp-client/pugchamp-client-restrictions-behavior.html">
<link rel="import" href="/elements/pugchamp-icons/pugchamp-role-icons.html">
<link rel="import" href="/elements/pugchamp-notification/pugchamp-notification.html">
<link rel="import" href="/elements/pugchamp-utilities/pugchamp-polymer-helpers.html">

<dom-module id="pugchamp-launchpad">
    <template>
        <style is="custom-style">
            .condition {
                background: var(--paper-amber-300);
                margin: 10px 0;
                padding: 10px;
            }

            #captains div {
                padding: 5px;
            }

            #ready {
                padding: 5px 25px;
                margin: 20px;
            }

            #readyTime {
                --paper-progress-height: 10px;
            }

            #ready paper-button {
                background: var(--primary-color);
                color: var(--dark-theme-text-color);
            }

            .player {
                min-height: inherit;
                height: 32px;
            }

            .player.highlight {
                font-weight: 700;
            }
        </style>

        <paper-material id="ready" hidden$="{{!launchInProgress}}">
            <h2>Launch In Progress</h2>

            <p><paper-progress id="readyTime" class="transiting" min="0"></paper-progress></p>
            <p>
                <paper-button data-status="ready" hidden$="{{readyToPlay}}" disabled="{{isRestricted(restrictions, 'start')}}" on-tap="updateReadyStatus">Set Ready</paper-button>
                <paper-button data-status="notReady" hidden$="{{!readyToPlay}}" disabled="{{isRestricted(restrictions, 'start')}}" on-tap="updateReadyStatus">Set Not Ready</paper-button>
            </p>
        </paper-material>
        <paper-material class="condition" hidden$="{{!_includes(conditions, 'notAvailable')}}">
            There are currently not enough people to launch a game.
        </paper-material>
        <paper-material class="condition" hidden$="{{!_includes(conditions, 'readyNotChecked')}}">
            A game will launch if enough people are ready after this ready period.
        </paper-material>
        <paper-material class="condition" hidden$="{{!_includes(conditions, 'notReady')}}">
            Not enough people were ready to play.
        </paper-material>
        <paper-material class="condition" hidden$="{{!_includes(conditions, 'draftCurrentlyRunning')}}">
            A draft is currently running.
        </paper-material>
        <paper-material class="condition" hidden$="{{!_includes(conditions, 'noAvailableServers')}}">
            No servers are available to play on.
        </paper-material>
        <div class="horizontal layout" id="captains">
            <div>
                <paper-checkbox id="captainSelect" disabled="{{isRestricted(restrictions, 'captain')}}" on-change="updateAvailability">Captain</paper-checkbox>
            </div>
            <div class="flex" id="captains-list">
                {{playerAliasList(captains)}}
            </div>
        </div>
        <div class="horizontal layout wrap" id="roles">
            <template is="dom-repeat" items="{{_convertObjectToRepeatable(roles)}}" as="role">
                <div class="flex role-column">
                    <div class="vertical layout">
                        <paper-icon-item>
							<iron-icon icon="pugchamp-role:{{role.key}}" item-icon></iron-icon>
                            <div class="role-name flex">
                                <h3>{{role.value.name}}</h3>
                            </div>
                            <paper-checkbox class="role-select" value="{{role.key}}" disabled="{{isRestricted(restrictions, 'start')}}" on-change="updateAvailability"></paper-checkbox>
                        </paper-icon-item>
                        <template is="dom-repeat" items="{{_getProperty(players, role.key)}}">
                            <paper-icon-item class$="player {{isHighlighted(item.steamID, highlightedPlayer)}}" on-mouseover="addHighlight" on-mouseout="removeHighlight">
                                <div class="flex">{{item.alias}}</div>
                            </paper-icon-item>
                        </template>
                    </div>
                </div>
            </template>
        </div>

        <pugchamp-notification id="launchNotification" body="A new game is launching!" tag="launchAttempt"></pugchamp-notification>

        <audio preload id="notifySound">
            <source src="/assets/snd/pop.mp3" type="audio/mpeg">
        </audio>
    </template>

    <script>
        Polymer({
            is: 'pugchamp-launchpad',
            behaviors: [PugChampPolymerHelperBehaviors, PugChampClientBehaviors.BaseBehavior, PugChampClientBehaviors.RestrictionsBehavior],
            ready: function() {
                this.set('launchInProgress', false);
                this.set('readyToPlay', false);

                this._listenToEvent('launchStatusUpdated', 'onLaunchStatusUpdated');
                this._listenToEvent('userAvailabilityUpdated', 'onUserAvailabilityUpdated');
                this._listenToEvent('userReadyStatusUpdated', 'onUserReadyStatusUpdated');
                this._listenToEvent('launchInProgress', 'onLaunchInProgress');
                this._listenToEvent('launchAborted', 'onLaunchAborted');
                this._listenToEvent('draftStarting', 'onDraftStarting');
            },
            onLaunchStatusUpdated: function(status) {
                this.set('roles', status.roles);
                this.set('players', status.playersAvailable);
                this.set('captains', status.captainsAvailable);
                this.set('rolesNeeded', status.rolesNeeded);
                this.set('conditions', status.missingLaunchConditions);
            },
            updateAvailability: function() {
                var roles = [];

                Polymer.dom(this.$.roles).querySelectorAll('.role-select').forEach(function(button) {
                    if (button.checked) {
                        roles.push(button.value);
                    }
                });

                var captain = this.$.captainSelect.checked;

                socket.emit('updateAvailability', {
                    roles: roles,
                    captain: captain
                });
            },
            onUserAvailabilityUpdated: function(availability) {
                Polymer.dom(this.$.roles).querySelectorAll('.role-select').forEach(function(button) {
                    button.checked = availability.roles[button.value];
                });

                this.$.captainSelect.checked = availability.captain;
            },
            onLaunchInProgress: function(periodInfo) {
                this.set('launchInProgress', true);

                this.$.launchNotification.notify();
                this.$.notifySound.currentTime = 0;
                this.$.notifySound.play();

                this.$.readyTime.value = periodInfo.elapsed / 1000;
                this.$.readyTime.max = periodInfo.total / 1000;

                this.async(this.incrementReadyTimer, 1000);
            },
            incrementReadyTimer: function() {
                this.$.readyTime.value++;

                if (this.$.readyTime.ratio < 100) {
                    this.async(this.incrementReadyTimer, 1000);
                }
            },
            updateReadyStatus: function(event) {
                socket.emit('updateReadyStatus', event.target.dataset.status === 'ready');
            },
            onUserReadyStatusUpdated: function(ready) {
                this.set('readyToPlay', ready);
            },
            onLaunchAborted: function() {
                this.resetReady();
            },
            onDraftStarting: function() {
                this.resetReady();
            },
            resetReady: function() {
                this.set('launchInProgress', false);

                this.$.launchNotification.close();
                if (!this.readyToPlay) {
                    Polymer.dom(this.$.roles).querySelectorAll('.role-select').forEach(function(button) {
                        button.checked = false;
                    });

                    this.$.captainSelect.checked = false;
                }

                this.set('readyToPlay', false);
            },
            playerAliasList: function(players) {
                return players.map(function(player) {
                    return player.alias;
                }).join(', ');
            },
            displayRolesNeeded: function(rolesNeeded) {
                return rolesNeeded.map(function(needed) {
                    var rolesString = needed.roles.map(function(role) {
                        return this.roles[role].name;
                    }, this).join('/');

                    return rolesString + ' (' + needed.needed + ')';
                }, this).join('; ');
            },
            isHighlighted: function(player, highlighted) {
                if (player === highlighted) {
                    return 'highlight';
                }
            },
            addHighlight: function(event) {
                this.set('highlightedPlayer', event.model.item.steamID);
            },
            removeHighlight: function(event) {
                if (this.highlightedPlayer === event.model.item.steamID) {
                    this.set('highlightedPlayer', null);
                }
            }
        });
    </script>
</dom-module>
